# 얼굴 분석 통계 업데이트 가이드

## ✨ 새로 추가된 기능

**통계 & 로그 탭**에 **실시간 얼굴 분석 통계**가 추가되었습니다!

---

## 📊 통계 항목

### **1. 🎭 총 검출 얼굴**
- 실시간으로 검출된 총 얼굴 수 카운팅
- 프레임마다 업데이트

### **2. 😊 표정 분포**
실시간으로 감지된 6가지 표정의 분포를 퍼센트로 표시:
- 😐 **Neutral (중립)** - 평상시 얼굴
- 😊 **Happy (행복)** - 미소, 웃음
- 😢 **Sad (슬픔)** - 우울한 표정
- 😲 **Surprised (놀람)** - 눈썹 올림 + 입 벌림
- 😖 **Pain (고통)** - 찡그림, 불편함
- 😠 **Angry (화남)** - 눈썹 좁힘

**예시 표시:**
```
😊 Happy: 45 (62.5%)
😐 Neutral: 18 (25.0%)
😲 Surprised: 9 (12.5%)

최근 표정: happy
```

### **3. 👁️ 눈 상태**
- **눈 뜸 (Eyes Open)** - 개안 상태 카운트
- **눈 감음 (Eyes Closed)** - 폐안 상태 카운트
- **개안율 프로그레스 바** - 눈 뜬 비율 시각화

### **4. 👄 입 상태**
3가지 입 상태 카운팅:
- **닫힘 (Closed)** - 입을 다문 상태
- **말하기 (Speaking)** - 말하거나 약간 벌린 상태
- **크게 열림 (Wide Open)** - 하품, 고함, 크게 벌린 상태

### **5. 😷 마스크/호흡기 착용**
- 마스크 또는 호흡기 착용 감지 횟수
- 의료 환경에서 유용

---

## 🎯 통계 탭 UI 구조

```
📊 통계 & 로그 탭
│
├── 😊 얼굴 분석 통계 (얼굴 분석 활성화 시에만 표시)
│   ├── [열 1] 🎭 총 검출 얼굴 + 표정 분포 + 최근 표정
│   ├── [열 2] 👁️ 눈 상태 (뜸/감음) + 개안율 프로그레스 바
│   ├── [열 3] 👄 입 상태 (닫힘/말하기/크게 열림) + 😷 마스크 착용
│   └── [버튼] 🔄 얼굴 분석 통계 초기화
│
├── 📊 YOLO 검출 통계
│   └── ROI별 상태 및 카운트
│
└── 📝 이벤트 로그
    └── 시간별 이벤트 기록
```

---

## 🚀 사용 방법

### **1. 얼굴 분석 활성화**
```bash
# Streamlit 앱 실행
streamlit run streamlit_app.py
```

**사이드바 설정:**
1. "😊 얼굴 분석" 섹션
2. "얼굴 분석 활성화" ✅ 체크
3. "💾 설정 저장" 클릭

### **2. 실시간 검출 시작**
1. "🎥 실시간 검출" 탭 이동
2. "▶️ 실시간 검출 시작" 버튼 클릭
3. 카메라 앞에서 다양한 표정 시도

### **3. 통계 확인**
1. "📊 통계 & 로그" 탭 이동
2. **"😊 얼굴 분석 통계"** 섹션 자동 표시 (얼굴 검출 시)
3. 실시간 업데이트되는 통계 확인

### **4. 통계 초기화**
- "🔄 얼굴 분석 통계 초기화" 버튼 클릭
- 모든 카운터가 0으로 리셋

---

## 🧪 테스트 시나리오

### **표정 변화 테스트**
1. **중립 표정 유지** → Neutral 카운트 증가
2. **미소 짓기** → Happy 카운트 증가
3. **눈썹 올리고 입 벌리기** → Surprised 카운트 증가
4. **입꼬리 내리기** → Sad 카운트 증가
5. **찡그리기** → Pain 카운트 증가
6. **눈썹 좁히기** → Angry 카운트 증가

**기대 결과:**
```
표정 분포
😊 Happy: 120 (40.0%)
😐 Neutral: 90 (30.0%)
😲 Surprised: 60 (20.0%)
😢 Sad: 15 (5.0%)
😖 Pain: 10 (3.3%)
😠 Angry: 5 (1.7%)

최근 표정: happy
```

### **눈 깜빡임 테스트**
1. **눈 뜨고 있기** → Eyes Open 카운트 증가
2. **눈 감기** → Eyes Closed 카운트 증가
3. **반복** → 개안율 퍼센트 확인

**기대 결과:**
```
👁️ 눈 상태
눈 뜸: 850
눈 감음: 150

개안율: 85.0%
```

### **입 상태 테스트**
1. **입 다물기** → Closed 카운트 증가
2. **말하기** → Speaking 카운트 증가
3. **하품하기** → Wide Open 카운트 증가

**기대 결과:**
```
👄 입 상태
닫힘: 600
말하기: 350
크게 열림: 50
```

### **마스크 착용 테스트**
1. **마스크 착용** → Mask 카운트 증가
2. **마스크 제거** → 카운트 유지

---

## 📊 통계 데이터 구조

### **Session State 변수**
```python
st.session_state.face_analysis_stats = {
    'total_faces_detected': 0,           # 총 얼굴 검출 수
    'expressions': {                     # 표정별 카운트
        'neutral': 0,
        'happy': 0,
        'sad': 0,
        'surprised': 0,
        'pain': 0,
        'angry': 0
    },
    'eyes_open_count': 0,                # 눈 뜬 횟수
    'eyes_closed_count': 0,              # 눈 감은 횟수
    'mouth_closed_count': 0,             # 입 닫힘 횟수
    'mouth_speaking_count': 0,           # 말하기 횟수
    'mouth_wide_open_count': 0,          # 입 크게 열림 횟수
    'mask_detected_count': 0,            # 마스크 검출 횟수
    'last_expression': None,             # 최근 표정
    'last_update': None                  # 마지막 업데이트 시간
}
```

---

## 💡 활용 예시

### **1. 의료/병원 환경**
- **통증 모니터링**: Pain 표정 카운트 추적
- **호흡기 착용 감시**: 마스크/호흡기 검출 통계
- **의식 상태 확인**: 눈 개안율 모니터링

### **2. 심리 상담/치료**
- **감정 변화 추적**: 표정 분포 그래프
- **스트레스 감지**: Angry, Pain 표정 증가 감지
- **치료 효과 측정**: Happy 표정 증가 확인

### **3. 교육/훈련**
- **집중도 측정**: 눈 감음 횟수로 졸음 감지
- **참여도 분석**: 표정 변화의 다양성 확인
- **반응 평가**: Surprised 표정으로 관심도 측정

### **4. 보안/출입 통제**
- **얼굴 검출 빈도**: 관심 구역 출입 통계
- **비정상 행동 감지**: 특정 표정 패턴 분석
- **마스크 착용 규정 준수**: 착용율 통계

---

## 🔧 기술 구현

### **통계 수집 방식**
```python
# realtime_detector.py의 last_face_results에서 실시간 수집
if hasattr(st.session_state.detector, 'last_face_results'):
    for bbox, face_result in st.session_state.detector.last_face_results.items():
        # 눈 상태
        if face_result.get('eyes_open'):
            stats['eyes_open_count'] += 1
        
        # 표정
        expr_info = face_result.get('expression', {})
        expression = expr_info.get('expression', 'neutral')
        stats['expressions'][expression] += 1
        
        # 입 상태
        mouth_state = face_result.get('mouth_state', 'closed')
        stats[f'mouth_{mouth_state}_count'] += 1
```

### **UI 업데이트 주기**
- **실시간 프레임**: 30 FPS (0.033초마다)
- **통계 카운팅**: 프레임마다 증분
- **UI 렌더링**: Streamlit 자동 새로고침

---

## 🚨 주의사항

### **1. 통계 누적 방식**
- 통계는 **검출 시작 후 누적**됩니다
- 프레임마다 증분되므로 **카운트가 빠르게 증가**합니다
- 필요 시 "🔄 통계 초기화" 버튼으로 리셋

### **2. 얼굴 분석 비활성화 시**
- 얼굴 분석이 비활성화되면 **통계 섹션이 표시되지 않습니다**
- 활성화 후 얼굴이 검출되면 자동으로 표시됩니다

### **3. 성능 고려**
- 통계 수집은 **최소한의 오버헤드**만 발생
- 카운팅만 하므로 FPS에 거의 영향 없음

---

## 📚 관련 문서

- `FACE_ANALYSIS_ACTIVATION_GUIDE.md` - 얼굴 분석 활성화 가이드
- `FACE_ANALYSIS_QUICKSTART.md` - 빠른 시작 가이드
- `FACE_ANALYSIS_INTEGRATION.md` - 통합 상세 가이드

---

## ✨ 업데이트 내역

### **v2.2 (최신)**
- ✅ 얼굴 분석 실시간 통계 추가
- ✅ 표정 분포 퍼센트 표시
- ✅ 눈 개안율 프로그레스 바
- ✅ 입 상태 3단계 카운팅
- ✅ 마스크/호흡기 착용 통계
- ✅ 통계 초기화 기능

### **v2.1**
- 얼굴 분석 활성화 로직 수정
- 표정 표시 개선

---

**🎉 이제 통계 탭에서 얼굴 분석 통계를 실시간으로 확인하세요!**  
**"📊 통계 & 로그" 탭 → "😊 얼굴 분석 통계" 섹션**
