# YOLO 검출 간격과 얼굴 분석 동기화 설명

## ✅ 완벽하게 동기화되어 있습니다!

왼쪽 사이드바의 **"🔄 YOLO 검출 간격"** 설정이 **YOLO 추론**과 **얼굴 분석** 모두를 제어합니다.

---

## 🎯 동작 원리

### **설정 위치**
**Streamlit 사이드바 → "🎯 검출 설정" → "🔄 YOLO 검출 간격 (초)"**

```
선택 가능한 값: 0.5초, 1.0초, 2.0초, 3.0초, 5.0초
```

### **처리 흐름**

```
┌─────────────────────────────────────────────────────────────┐
│           프레임 처리 루프 (30 FPS)                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
        ┌──────────────────────────────────────┐
        │  타이머 체크:                         │
        │  현재 시간 - 마지막 검출 시간 ≥       │
        │  detection_interval_seconds?         │
        └──────────────────────────────────────┘
                          ↓
            NO ←─────────┴────────→ YES
            │                      │
            ↓                      ↓
  ┌─────────────────┐    ┌─────────────────────────┐
  │ 이전 검출 결과   │    │  1️⃣ YOLO 추론 실행      │
  │ 재사용 (빠름)    │    │  (사람 검출)             │
  │                 │    └─────────────────────────┘
  │ - 시각화만 업데이트│              ↓
  │ - FPS 유지      │    ┌─────────────────────────┐
  └─────────────────┘    │  2️⃣ 얼굴 분석 실행      │
                         │  (동일한 타이밍)         │
                         │                         │
                         │  - 표정 분석            │
                         │  - 눈 상태              │
                         │  - 입 상태              │
                         │  - 마스크 검출          │
                         └─────────────────────────┘
                                   ↓
                         ┌─────────────────────────┐
                         │  결과 저장 및 시각화    │
                         │  - last_detections      │
                         │  - last_face_results    │
                         │  - 통계 업데이트        │
                         └─────────────────────────┘
```

---

## 📊 설정별 동작 예시

### **예시 1: detection_interval = 0.5초**

```
시간(초)  프레임#  YOLO 추론  얼굴 분석  동작
─────────────────────────────────────────────
0.00      1       ✅ 실행    ✅ 실행    초기 검출
0.03      2       ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
0.06      3       ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
0.09      4       ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
...
0.50      16      ✅ 실행    ✅ 실행    0.5초 경과 → 재검출
0.53      17      ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
...
1.00      31      ✅ 실행    ✅ 실행    0.5초 경과 → 재검출
```

**결과**: 1초당 **2회** 검출 + 얼굴 분석

---

### **예시 2: detection_interval = 1.0초 (기본값)**

```
시간(초)  프레임#  YOLO 추론  얼굴 분석  동작
─────────────────────────────────────────────
0.00      1       ✅ 실행    ✅ 실행    초기 검출
0.03      2       ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
0.06      3       ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
...
0.97      30      ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
1.00      31      ✅ 실행    ✅ 실행    1.0초 경과 → 재검출
1.03      32      ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
...
2.00      61      ✅ 실행    ✅ 실행    1.0초 경과 → 재검출
```

**결과**: 1초당 **1회** 검출 + 얼굴 분석

---

### **예시 3: detection_interval = 2.0초**

```
시간(초)  프레임#  YOLO 추론  얼굴 분석  동작
─────────────────────────────────────────────
0.00      1       ✅ 실행    ✅ 실행    초기 검출
0.03      2       ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
...
1.97      60      ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
2.00      61      ✅ 실행    ✅ 실행    2.0초 경과 → 재검출
2.03      62      ⏭️ 재사용  ⏭️ 재사용  이전 결과 사용
...
4.00      121     ✅ 실행    ✅ 실행    2.0초 경과 → 재검출
```

**결과**: 1초당 **0.5회** 검출 + 얼굴 분석

---

## 💡 핵심 포인트

### **1. 단일 타이머 사용**
```python
# realtime_detector.py
if current_time - self.last_detection_time >= self.detection_interval:
    # ✅ YOLO 추론
    results = self.model(frame)
    
    # ✅ 얼굴 분석 (동일한 if 블록 내부)
    if self.enable_face_analysis:
        for detection in detections:
            face_result = self.face_analyzer.analyze_face(frame, bbox)
    
    # ✅ 타이머 리셋 (YOLO와 얼굴 분석 모두 동일한 타이머 사용)
    self.last_detection_time = current_time
```

### **2. 동일한 설정 값 공유**
```python
# config.json
{
  "detection_interval_seconds": 1.0  // ← 이 값이 모두 제어
}

# realtime_detector.py
self.detection_interval = config.get('detection_interval_seconds', 1.0)
```

### **3. 완벽한 동기화**
- YOLO 추론할 때 **반드시** 얼굴 분석도 함께 실행
- 별도의 타이머나 간격 설정 없음
- 설정 변경 시 **자동으로 함께 변경**

---

## 📊 통계 누적 속도 (1분 동안)

| 검출 간격 | YOLO 추론 횟수 | 얼굴 분석 횟수 | 통계 카운트 (1인 기준) |
|----------|---------------|---------------|----------------------|
| **0.5초** | 120회 | 120회 | ~120 |
| **1.0초** | 60회 | 60회 | ~60 |
| **2.0초** | 30회 | 30회 | ~30 |
| **3.0초** | 20회 | 20회 | ~20 |
| **5.0초** | 12회 | 12회 | ~12 |

**이전 (버그)**: 검출 간격 무관하게 **1,800회** (30 FPS × 60초)

---

## 🎯 사용자 확인 방법

### **1. 콘솔 로그 확인**
검출 간격을 변경하고 로그 빈도를 관찰하세요:

```bash
# detection_interval = 1.0초 설정 시
[RealtimeDetector] YOLO 추론 실행 (간격: 1.0초)
[RealtimeDetector] 얼굴 분석 실행 (1명 검출)
[RealtimeDetector] ✅ 얼굴 분석 완료: Eyes=Open, Mouth=closed, Expression=neutral (0.50)

# 약 1초 후...
[RealtimeDetector] YOLO 추론 실행 (간격: 1.0초)
[RealtimeDetector] 얼굴 분석 실행 (1명 검출)
[RealtimeDetector] ✅ 얼굴 분석 완료: Eyes=Open, Mouth=speaking, Expression=happy (0.78)
```

**확인 포인트**:
- "YOLO 추론 실행" 로그와 "얼굴 분석 실행" 로그가 **항상 함께 출력**
- 로그 간격이 설정한 `detection_interval_seconds`와 일치

### **2. 통계 누적 속도 확인**
"📊 통계 & 로그" 탭에서 "🎭 총 검출 얼굴" 카운터 관찰:

```
검출 간격 1.0초 설정 시:
- 10초 후: 약 10건
- 30초 후: 약 30건
- 60초 후: 약 60건

검출 간격 2.0초 설정 시:
- 10초 후: 약 5건
- 30초 후: 약 15건
- 60초 후: 약 30건
```

### **3. 설정 변경 실험**

**실험 순서**:
1. 사이드바 → "🔄 YOLO 검출 간격" → **1.0초** 선택
2. "💾 설정 저장" 클릭
3. 실시간 검출 시작
4. 30초 동안 대기
5. 통계 확인: 약 **30건**
6. 검출 중지
7. "🔄 얼굴 분석 통계 초기화" 클릭
8. "🔄 YOLO 검출 간격" → **2.0초** 선택
9. "💾 설정 저장" 클릭
10. 실시간 검출 다시 시작
11. 30초 동안 대기
12. 통계 확인: 약 **15건** (절반으로 감소)

---

## 🚀 최적 설정 추천

### **시나리오별 권장 설정**

#### **1. 실시간 모니터링 (응급/보안)**
```json
{
  "detection_interval_seconds": 0.5,
  "face_analysis_roi_only": true
}
```
- **빠른 반응**: 0.5초마다 검출
- **ROI 집중**: ROI 내부만 분석하여 성능 확보

#### **2. 일반 모니터링 (권장)**
```json
{
  "detection_interval_seconds": 1.0,
  "face_analysis_roi_only": false
}
```
- **균형잡힌 성능**: 1초 간격으로 충분한 정보
- **전체 화면 분석**: 모든 얼굴 추적

#### **3. 저전력/장시간 모니터링**
```json
{
  "detection_interval_seconds": 3.0,
  "face_analysis_roi_only": true
}
```
- **낮은 리소스 사용**: 3초 간격으로 전력 절약
- **ROI 집중**: 중요 영역만 모니터링

---

## 🔧 코드 구조 (참고)

### **realtime_detector.py 핵심 로직**
```python
def process_frame(self):
    current_time = time.time()
    
    # ✅ 단일 타이머로 YOLO와 얼굴 분석 모두 제어
    if current_time - self.last_detection_time >= self.detection_interval:
        # YOLO 추론
        results = self.model(frame)
        detections = [...]
        
        # 얼굴 분석 (동일한 타이밍)
        if self.enable_face_analysis and self.face_analyzer:
            for detection in detections:
                face_result = self.face_analyzer.analyze_face(frame, bbox)
                self.last_face_results[tuple(bbox)] = face_result
        
        # 타이머 리셋 (공통)
        self.last_detection_time = current_time
    else:
        # 이전 결과 재사용 (YOLO + 얼굴 분석 모두)
        detections = self.last_detections  # YOLO 결과
        # self.last_face_results도 그대로 유지
```

---

## ✅ 정리

**질문**: 왼쪽 패널에서 설정하는 YOLO 검출 주기와 안면 분석 주기가 동기화 된 것인가?

**답변**: **네, 완벽하게 동기화되어 있습니다!**

1. ✅ **단일 설정**: "🔄 YOLO 검출 간격" 하나로 모두 제어
2. ✅ **동시 실행**: YOLO 추론할 때 얼굴 분석도 함께 실행
3. ✅ **동일한 타이머**: `self.last_detection_time` 공유
4. ✅ **완벽한 동기화**: 별도 설정 없이 자동으로 동기화

**사용자가 할 일**: 
- 사이드바에서 **"🔄 YOLO 검출 간격"** 만 조정하면 됩니다.
- YOLO와 얼굴 분석이 **자동으로 함께 조정**됩니다.

**설정 값 → 검출 빈도**:
- 0.5초 → 2회/초
- 1.0초 → 1회/초 (권장)
- 2.0초 → 0.5회/초
- 3.0초 → 0.33회/초
- 5.0초 → 0.2회/초
